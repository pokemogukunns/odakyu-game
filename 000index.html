<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>鉄球進化シミュレーション</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #game-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f0f0f0;
      }
      canvas {
        border: 1px solid #000;
      }
      #controls {
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: #fff;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
      }
      #score-container {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #fff;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
      }
      #gameOverMessage {
        display: none;
        color: red;
        font-size: 20px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  </head>
  <body>
    <div id="game-container">
      <div id="controls">
        <label for="gravityInput">重力の強さを入力 (例: 0.1〜1.0): </label>
        <input type="number" id="gravityInput" value="0.5" step="0.1" />
        <button id="applyGravity">重力を適用</button>
        <button id="expandButton">拡大</button>
      </div>
      <div id="score-container">
        スコア: <span id="score">0</span>
      </div>
      <p id="gameOverMessage">ゲームオーバー！</p>
    </div>
    <script>
      let balls = [];
      let gravity = 0.5;
      let evolveImages = [];
      let score = 0;
      let gameOver = false;
      let canvas;
      const MAX_SCORE = 10000; // 特別な最大スコア
      const SPECIAL_SCORE = 500; // 17番目に多いスコア
      const SCORE_INCREMENT = 0.10; // スコアの増加率
      const BALL_SIZE = 10; // さくらんぼの50%サイズ（例：10pxでスタート）
      const EVOLVED_IMAGE_INDEX = 9; // IMG_0036_0915094747 のインデックス

      function preload() {
        // 進化の順に画像を読み込む
        let imagePaths = [
          'IMG_0027_0915094511.png', 'IMG_0028_0915094532.png', 'IMG_0029_0915094551.png',
          'IMG_0030_0915094604.png', 'IMG_0031_0915094617.png', 'IMG_0032_0915094632.png',
          'IMG_0033_0915094656.png', 'IMG_0034_0915094710.png', 'IMG_0035_0915094729.png',
          'IMG_0036_0915094747.png', 'IMG_0037_0915094758.png', 'IMG_0038_0915094812.png',
          'IMG_0039_0915094826.png', 'IMG_0040_0915094851.png', 'IMG_0051_0915095150.png',
          'IMG_0041_0915094910.png', 'IMG_0042_0915094930.png', 'IMG_0043_0915094945.png',
          'IMG_0044_0915094957.png', 'IMG_0045_0915095011.png', 'IMG_0046_0915095024.png',
          'IMG_0047_0915095034.png', 'IMG_0048_0915095053.png', 'IMG_0049_0915095117.png',
          'IMG_0050_0915095137.png'
        ];

        for (let path of imagePaths) {
          evolveImages.push(loadImage(path)); // 画像を配列にロード
        }
      }

      function setup() {
        canvas = createCanvas(windowWidth, windowHeight);
        canvas.parent('game-container'); // canvas を指定の div に追加

        document.getElementById('applyGravity').addEventListener('click', function () {
          gravity = parseFloat(document.getElementById('gravityInput').value);
        });

        document.getElementById('expandButton').addEventListener('click', function () {
          resizeCanvas(windowWidth, windowHeight);
          redraw(); // 再描画
        });

        // マウスクリックで鉄球（画像）を生成
        canvas.elt.addEventListener('click', function (event) {
          if (!gameOver) {
            let mouseXPosition = event.clientX - canvas.elt.offsetLeft;
            let yPosition = height / 3; // y座標は画面の上から3分の1に固定
            let randomIndex = Math.floor(Math.random() * 5); // 画像は 0〜4 インデックス
            balls.push(new IronBall(mouseXPosition, yPosition, randomIndex));
          }
        });
      }

      function draw() {
        if (gameOver) {
          return; // ゲームオーバー後は描画を停止
        }

        background(220);

        for (let ball of balls) {
          ball.update();
          ball.display();

          // y座標が上3分の1の半分以上超えたらゲームオーバー
          let upperLimit = height / 3;
          if (ball.y - ball.diameter / 2 < upperLimit) {
            triggerGameOver();
            return;
          }
        }

        // ボール同士が接触したかチェック
        if (balls.length >= 2) {
          for (let i = 0; i < balls.length - 1; i++) {
            for (let j = i + 1; j < balls.length; j++) {
              if (ballsTouching(balls[i], balls[j])) {
                handleCollision(balls[i], balls[j]);
              }
            }
          }
        }
      }

      class IronBall {
        constructor(x, y, evolutionIndex) {
          this.x = x;
          this.y = y;
          this.velocity = 0;
          this.diameter = BALL_SIZE;
          this.evolutionIndex = evolutionIndex; // 進化段階のインデックス
        }

        update() {
          this.velocity += gravity;
          this.y += this.velocity;

          // 転がる場所の制限 (画面の右1/3〜2/3、上1/3〜下9/10の範囲内に限定)
          let leftBound = width * (1 / 3);
          let rightBound = width * (2 / 3);
          let upperBound = height * (1 / 3);
          let lowerBound = height * (9 / 10);

          if (this.x < leftBound) {
            this.x = leftBound;
          } else if (this.x > rightBound) {
            this.x = rightBound;
          }

          if (this.y < upperBound) {
            this.y = upperBound;
          } else if (this.y > lowerBound) {
            this.y = lowerBound;
            this.velocity *= -0.3; // 跳ね返り
          }
        }

        display() {
          image(evolveImages[this.evolutionIndex], this.x - this.diameter / 2, this.y - this.diameter / 2, this.diameter, this.diameter);
        }
      }

      function ballsTouching(ball1, ball2) {
        let distance = dist(ball1.x, ball1.y, ball2.x, ball2.y);
        return distance < (ball1.diameter + ball2.diameter) / 2;
      }

      function handleCollision(ball1, ball2) {
        // プレイヤーが落とせる画像は IMG_0027_0915094511 から IMG_0031_0915094617 まで
        if (
          (ball1.evolutionIndex >= 0 && ball1.evolutionIndex <= 4) &&
          (ball2.evolutionIndex >= 0 && ball2.evolutionIndex <= 4)
        ) {
          // 進化処理とスコア処理
          if (ball1.evolutionIndex === ball2.evolutionIndex) {
            evolveBall(ball1, ball2);
            increaseScore(10 + score * SCORE_INCREMENT); // スコアが段々増える
            if (ball1.evolutionIndex === EVOLVED_IMAGE_INDEX) {
              removeBalls(ball1, ball2); // 進化した後は元の画像を消去
            }
          }
        }

        // IMG_0040_0915094851 と IMG_0051_0915095150 の組み合わせ
        if (
          (ball1.evolutionIndex === evolveImages.length - 9 && ball2.evolutionIndex === evolveImages.length - 10) ||
          (ball1.evolutionIndex === evolveImages.length - 10 && ball2.evolutionIndex === evolveImages.length - 9)
        ) {
          increaseScore(MAX_SCORE); // 特別な最大スコアを加算
          removeBalls(ball1, ball2); // 進化後の画像を消去
        }

        // IMG_0034_0915094710 と IMG_0035_0915094729 の組み合わせ
        if (
          (ball1.evolutionIndex === evolveImages.length - 17 && ball2.evolutionIndex === evolveImages.length - 16) ||
          (ball1.evolutionIndex === evolveImages.length - 16 && ball2.evolutionIndex === evolveImages.length - 17)
        ) {
          increaseScore(SPECIAL_SCORE); // 17番目に多いスコアを加算
          ball1.evolutionIndex = evolveImages.length - 7; // IMG_0036_0915094747 へ進化
          ball2.evolutionIndex = evolveImages.length - 7; // IMG_0036_0915094747 へ進化
          // 進化後の画像を描画する
          removeBalls(ball1, ball2); // 元の画像を消去
        }
      }

      function evolveBall(ball1, ball2) {
        // 進化の処理: 画像を次の段階へ進化させる
        if (ball1.evolutionIndex < evolveImages.length - 1) {
          ball1.evolutionIndex++;
        }
        if (ball2.evolutionIndex < evolveImages.length - 1) {
          ball2.evolutionIndex++;
        }
      }

      function removeBalls(ball1, ball2) {
        balls = balls.filter(ball => ball !== ball1 && ball !== ball2);
      }

      function increaseScore(amount = 10) {
        score += amount;
        document.getElementById('score').textContent = score;
      }

      function triggerGameOver() {
        gameOver = true;
        document.getElementById('gameOverMessage').style.display = 'block';
      }

      function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
      }
    </script>
  </body>
</html>
