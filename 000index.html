<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>鉄球進化シミュレーション</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  </head>
  <body>
    <h1>鉄球進化シミュレーション</h1>
    <label for="gravityInput">重力の強さを入力 (例: 0.1〜1.0): </label>
    <input type="number" id="gravityInput" value="0.5" step="0.1" />
    <button id="applyGravity">重力を適用</button>
    <p>スコア: <span id="score">0</span></p>
    <p id="gameOverMessage" style="display: none; color: red; font-size: 20px;">ゲームオーバー！</p>
    <script>
      let balls = [];
      let gravity = 0.5;
      let evolveImages = [];
      let score = 0;
      let gameOver = false;
      const MAX_SCORE = 10000; // 特別な最大スコア
      const SPECIAL_SCORE = 500; // 17番目に多いスコア
      const SCORE_INCREMENT = 0.10; // スコアの増加率
      const BALL_SIZE = 10; // さくらんぼの50%サイズ（例：10pxでスタート）
      const EVOLVED_IMAGE_INDEX = 10; // IMG_0036_0915094747 のインデックス

      function preload() {
        // 進化の順に画像を読み込む
        let imagePaths = [
          'IMG_0027_0915094511.jpg', 'IMG_0028_0915094532.jpg', 'IMG_0029_0915094551.jpg',
          'IMG_0030_0915094604.jpg', 'IMG_0031_0915094617.jpg', 'IMG_0032_0915094632.jpg',
          'IMG_0033_0915094656.jpg', 'IMG_0034_0915094710.jpg', 'IMG_0035_0915094729.jpg',
          'IMG_0036_0915094747.jpg', 'IMG_0037_0915094758.jpg', 'IMG_0038_0915094812.jpg',
          'IMG_0039_0915094826.jpg', 'IMG_0040_0915094851.jpg', 'IMG_0051_0915095150.jpg',
          'IMG_0041_0915094910.jpg', 'IMG_0042_0915094930.jpg', 'IMG_0043_0915094945.jpg',
          'IMG_0044_0915094957.jpg', 'IMG_0045_0915095011.jpg', 'IMG_0046_0915095024.jpg',
          'IMG_0047_0915095034.jpg', 'IMG_0048_0915095053.jpg', 'IMG_0049_0915095117.jpg',
          'IMG_0050_0915095137.jpg'
        ];

        for (let path of imagePaths) {
          evolveImages.push(loadImage(path)); // 画像を配列にロード
        }
      }

      function setup() {
        createCanvas(400, 400);

        document.getElementById('applyGravity').addEventListener('click', function () {
          gravity = parseFloat(document.getElementById('gravityInput').value);
        });

        // マウスクリックで鉄球（画像）を生成
        canvas.addEventListener('click', function () {
          if (!gameOver) {
            let mouseXPosition = mouseX;
            let yPosition = height / 3; // y座標は画面の上から3分の1に固定
            let randomIndex = Math.floor(Math.random() * 5); // 画像は 0〜4 インデックス
            balls.push(new IronBall(mouseXPosition, yPosition, randomIndex));
          }
        });
      }

      function draw() {
        if (gameOver) {
          return; // ゲームオーバー後は描画を停止
        }

        background(220);

        for (let ball of balls) {
          ball.update();
          ball.display();

          // y座標が上3分の1の半分以上超えたらゲームオーバー
          let upperLimit = height / 3;
          if (ball.y - ball.diameter / 2 < upperLimit) {
            triggerGameOver();
            return;
          }
        }

        // ボール同士が接触したかチェック
        if (balls.length >= 2) {
          for (let i = 0; i < balls.length - 1; i++) {
            for (let j = i + 1; j < balls.length; j++) {
              if (ballsTouching(balls[i], balls[j])) {
                handleCollision(balls[i], balls[j]);
              }
            }
          }
        }
      }

      class IronBall {
        constructor(x, y, evolutionIndex) {
          this.x = x;
          this.y = y;
          this.velocity = 0;
          this.diameter = BALL_SIZE;
          this.evolutionIndex = evolutionIndex; // 進化段階のインデックス
        }

        update() {
          this.velocity += gravity;
          this.y += this.velocity;

          // 転がる場所の制限 (画面の右1/3〜2/3、上1/3〜下9/10の範囲内に限定)
          let leftBound = width * (1 / 3);
          let rightBound = width * (2 / 3);
          let upperBound = height * (1 / 3);
          let lowerBound = height * (9 / 10);

          if (this.x < leftBound) {
            this.x = leftBound;
          } else if (this.x > rightBound) {
            this.x = rightBound;
          }

          if (this.y < upperBound) {
            this.y = upperBound;
          } else if (this.y > lowerBound) {
            this.y = lowerBound;
            this.velocity *= -0.3; // 跳ね返り
          }
        }

        display() {
          image(evolveImages[this.evolutionIndex], this.x - this.diameter / 2, this.y - this.diameter / 2, this.diameter, this.diameter);
        }
      }

      function ballsTouching(ball1, ball2) {
        let distance = dist(ball1.x, ball1.y, ball2.x, ball2.y);
        return distance < (ball1.diameter + ball2.diameter) / 2;
      }

      function handleCollision(ball1, ball2) {
        // プレイヤーが落とせる画像の範囲
        if (
          (ball1.evolutionIndex >= 0 && ball1.evolutionIndex <= 4) &&
          (ball2.evolutionIndex >= 0 && ball2.evolutionIndex <= 4)
        ) {
          // 同じ画像同士のスコアを10%増加させる
          if (ball1.evolutionIndex === ball2.evolutionIndex) {
            let increment = Math.floor(score * SCORE_INCREMENT);
            increaseScore(increment); // 10% 増加
            evolveBall(ball1, ball2); // 進化する処理
          }
          // IMG_0040_0915094851 と IMG_0051_0915095150 の組み合わせで特別な最大スコア
          else if (
            (ball1.evolutionIndex === evolveImages.length - 11 && ball2.evolutionIndex === evolveImages.length - 11) || // IMG_0040_0915094851 同士
            (ball1.evolutionIndex === evolveImages.length - 1 && ball2.evolutionIndex === evolveImages.length - 1) || // IMG_0051_0915095150 同士
            (ball1.evolutionIndex === evolveImages.length - 11 && ball2.evolutionIndex === evolveImages.length - 1) || // IMG_0040_0915094851 と IMG_0051_0915095150
            (ball1.evolutionIndex === evolveImages.length - 1 && ball2.evolutionIndex === evolveImages.length - 11)
          ) {
            increaseScore(MAX_SCORE); // 特別な最大スコアを加算
            removeBalls(ball1, ball2); // 画像を消去
          }
          // IMG_0034_0915094710 同士、または IMG_0034_0915094710 と IMG_0035_0915094729 の組み合わせ
          else if (
            (ball1.evolutionIndex === evolveImages.length - 17 && ball2.evolutionIndex === evolveImages.length - 17) || // IMG_0034_0915094710 同士
            (ball1.evolutionIndex === evolveImages.length - 17 && ball2.evolutionIndex === evolveImages.length - 16) || // IMG_0034_0915094710 と IMG_0035_0915094729
            (ball1.evolutionIndex === evolveImages.length - 16 && ball2.evolutionIndex === evolveImages.length - 16) // IMG_0035_0915094729 同士
          ) {
            increaseScore(SPECIAL_SCORE); // 17番目に多いスコアを加算
            ball1.evolutionIndex = EVOLVED_IMAGE_INDEX; // IMG_0036_0915094747 へ進化
            ball2.evolutionIndex = EVOLVED_IMAGE_INDEX; // IMG_0036_0915094747 へ進化
          }
          removeBalls(ball1, ball2); // 画像を消去
        }
      }

      function evolveBall(ball1, ball2) {
        // 進化の処理: 画像を次の段階へ進化させる
        if (ball1.evolutionIndex < evolveImages.length - 1) {
          ball1.evolutionIndex++;
        }
        if (ball2.evolutionIndex < evolveImages.length - 1) {
          ball2.evolutionIndex++;
        }
      }

      function removeBalls(ball1, ball2) {
        balls = balls.filter(ball => ball !== ball1 && ball !== ball2);
      }

      function increaseScore(amount = 10) {
        score += amount;
        document.getElementById('score').textContent = score;
      }

      function triggerGameOver() {
        gameOver = true;
        document.getElementById('gameOverMessage').style.display = 'block';
      }
    </script>
  </body>
</html>
