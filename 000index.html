<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ball Game</title>
  <style>
    body { margin: 0; }
    canvas { display: block; }
    #gameOverMessage {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      color: red;
      background: white;
      padding: 20px;
      border: 2px solid black;
    }
    #expandButton {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 10px 20px;
      background: lightblue;
      border: none;
      cursor: pointer;
    }
    #score {
      position: fixed;
      top: 10px;
      left: 10px;
      font-size: 20px;
    }
  </style>
</head>
<body>
  <div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="gameOverMessage">Game Over</div>
    <button id="expandButton">Expand Canvas</button>
    <div id="score">Score: 0</div>
  </div>

  <script>
    let canvas;
    let ctx;
    let balls = [];
    let score = 0;
    let gameOver = false;
    const GRAVITY = 0.1;
    const FRICTION = 0.98;
    const MAX_SCORE = 10000;
    const SPECIAL_SCORE = 500; // 17番目に多いスコア
    const SCORE_INCREMENT = 0.1; // スコアの増加率
    const BASE_RADIUS = 15; // 基本のボールの半径

    const evolveImages = [
      'IMG_0027_0915094511.png',
      'IMG_0028_0915094532.png',
      'IMG_0029_0915094551.png',
      'IMG_0030_0915094604.png',
      'IMG_0031_0915094617.png',
      'IMG_0032_0915094632.png',
      'IMG_0033_0915094656.png',
      'IMG_0034_0915094710.png',
      'IMG_0035_0915094729.png',
      'IMG_0036_0915094747.png',
      'IMG_0037_0915094758.png',
      'IMG_0038_0915094812.png',
      'IMG_0039_0915094826.png',
      'IMG_0040_0915094851.png',
      'IMG_0051_0915095150.png',
      'IMG_0041_0915094910.png',
      'IMG_0042_0915094930.png',
      'IMG_0043_0915094945.png',
      'IMG_0044_0915094957.png',
      'IMG_0045_0915095011.png',
      'IMG_0046_0915095024.png',
      'IMG_0047_0915095034.png',
      'IMG_0048_0915095053.png',
      'IMG_0049_0915095117.png',
      'IMG_0050_0915095137.png'
    ];

    window.onload = () => {
      canvas = document.getElementById('gameCanvas');
      ctx = canvas.getContext('2d');
      resizeCanvas(window.innerWidth * 0.8, window.innerHeight * 0.8);

      document.getElementById('expandButton').addEventListener('click', () => {
        resizeCanvas(window.innerWidth * 0.8, window.innerHeight * 0.8);
      });

      setup();
      requestAnimationFrame(gameLoop);
    };

    function setup() {
      // ボールの初期化処理を追加する
      // 例: balls.push(new Ball(x, y, initialImageIndex));
    }

    function gameLoop() {
      if (gameOver) return;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      for (let ball of balls) {
        ball.update();
        ball.display();
        handleBallCollisions(ball);
      }

      updateScore();
      requestAnimationFrame(gameLoop);
    }

    function handleBallCollisions(currentBall) {
      for (let otherBall of balls) {
        if (currentBall === otherBall) continue;

        let dx = otherBall.x - currentBall.x;
        let dy = otherBall.y - currentBall.y;
        let distance = Math.sqrt(dx * dx + dy * dy);
        let minDistance = (currentBall.radius + otherBall.radius);

        if (distance < minDistance) {
          let angle = Math.atan2(dy, dx);
          let overlap = minDistance - distance;
          let pushX = overlap * Math.cos(angle) / 2;
          let pushY = overlap * Math.sin(angle) / 2;

          currentBall.x -= pushX;
          currentBall.y -= pushY;
          otherBall.x += pushX;
          otherBall.y += pushY;

          handleCollision(currentBall, otherBall);
        }
      }
    }

    function updateScore() {
      document.getElementById('score').textContent = `Score: ${score}`;
    }

    function handleCollision(ball1, ball2) {
      // 特別なスコアを加算する条件
      if (
        (ball1.evolutionIndex === evolveImages.length - 9 && ball2.evolutionIndex === evolveImages.length - 10) ||
        (ball1.evolutionIndex === evolveImages.length - 10 && ball2.evolutionIndex === evolveImages.length - 9)
      ) {
        increaseScore(MAX_SCORE); // 特別な最大スコアを加算
        removeBalls(ball1, ball2); // 進化後の画像を消去
      }

      // 17番目に多いスコアを加算する条件
      if (
        (ball1.evolutionIndex === evolveImages.length - 17 && ball2.evolutionIndex === evolveImages.length - 16) ||
        (ball1.evolutionIndex === evolveImages.length - 16 && ball2.evolutionIndex === evolveImages.length - 17)
      ) {
        increaseScore(SPECIAL_SCORE); // 17番目に多いスコアを加算
        ball1.evolutionIndex = evolveImages.length - 7; // IMG_0036_0915094747 へ進化
        ball2.evolutionIndex = evolveImages.length - 7; // IMG_0036_0915094747 へ進化
        removeBalls(ball1, ball2); // 元の画像を消去
      }

      // 進化処理
      if (ball1.evolutionIndex === ball2.evolutionIndex) {
        evolveBall(ball1, ball2);
        increaseScore(10 + score * SCORE_INCREMENT); // スコアが段々増える
        if (ball1.evolutionIndex === evolveImages.length - 1) {
          removeBalls(ball1, ball2); // 進化後の画像を消去
        }
      }
    }

    function evolveBall(ball1, ball2) {
      if (ball1.evolutionIndex < evolveImages.length - 1) {
        ball1.evolutionIndex++;
        ball1.radius *= 1.1; // ボールのサイズを10%増加
      }
      if (ball2.evolutionIndex < evolveImages.length - 1) {
        ball2.evolutionIndex++;
        ball2.radius *= 1.1; // ボールのサイズを10%増加
      }
    }

    function removeBalls(ball1, ball2) {
      balls = balls.filter(ball => ball !== ball1 && ball !== ball2);
    }

    function increaseScore(amount = 10) {
      score += amount;
      updateScore();
    }

    function triggerGameOver() {
      gameOver = true;
      document.getElementById('gameOverMessage').style.display = 'block';
    }

    function resizeCanvas(width, height) {
      canvas.width = width;
      canvas.height = height;
    }
  </script>
</body>
</html>
